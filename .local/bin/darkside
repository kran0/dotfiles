#!/bin/bash -e

# Help
[ "${1}" == '--help' ] && exec cat << HELP

${0} is my portable network music player.
/Based on: bash, cat, curl, mpv, sed and shuf/

Workflow:
- If exist PLAYLIST_CACHE, use PLAYLIST_CACHE;
- Else extract M3U links from LIST (default LIST is defined at the botoom of the script);
- Filter links (default FLITERS are predefined);
- Exec player according to the PLAYER_MODE:
   PLAYER_MODE=stream - caching the music stream in RAM;
   PLAYER_MODE=playlist - caching the playlist in RAM.

Environment (optional):
: LIST    - filename with cURL --config syntax contens (/--config/ in man curl);
: FILTERS - list with sed expression[s] (man sed);
: PLAYER_MODE - [ stream | playlist ]

Examples:
 ${0}                                  # Use defaults: LIST, FILTERS;
 ${0} '/WarlocK/!d'                    # The same, but add custom filter;
 LIST=~/Music/playlist.curl ${0}       # Redefine LIST location;
 FILTERS='' ${0}                       # Disable predefined FILTERS;

HELP

# Environment from args
LIST="${LIST:-${0}}"
FILTERS="${FILTERS:-
/^#\|^[[:space:]]*$/d
/\/play_i\//d
/([Ll]ive/d
/\[[Ll]ive/d
/\/Live%20[Ii]n/d
/\/Live%20[Aa]t/d
/\/T\/Tarja\/Act%20I%20.Live%20...%20CD.%20.2012./d
/\/M\/Metallica\/Cliff.s%20Last%20Gig/d
/\/M\/Metallica\/Bilbao%20BBK%20Live%20Festival/d
/\/Q\/Queen\/At%20The%20BBC/d
}"
export PLAYLIST_CACHE="${PLAYLIST_CACHE:-$(mktemp --dry-run --suffix=.darkside)}"
trap 'rm -f ${PLAYLIST_CACHE}' EXIT
PLAYER_MODE="${PLAYER_MODE:-stream}" # playlist | stream | debug

# Environment from state

# We use socks proxy because there is no torify in termux avalible
ONION_PROXY="127.0.0.1:$(sed -ne 's/^TorPort //p' /etc/tor/torsocks.conf 2>/dev/null)"\
 || ONION_PROXY='127.0.0.1:9150'

case $(timeout 1 curl --silent --output /dev/null http://darkside.cc -w '%{http_code}\n') in
 200 ) CURL='curl'  ;;
 *   ) CURL='curl --socks5 ${ONION_PROXY} --socks5-hostname ${ONION_PROXY}
  --connect-to darkside.cc:80:foye3hwyvtthhoifpt6mnkowosras46uirxrx5brsjqawonhs4p44rad.onion:80
  --header "Host: foye3hwyvtthhoifpt6mnkowosras46uirxrx5brsjqawonhs4p44rad.onion"';
       PLAYER_MODE='stream' ;;
esac

# Functions
function getPlaylist {
 (
 echo 'url http://darkside.cc/m3u/group/$(shuf -i 1-285777 -n 1)'
 sed -e '1,/^########## M3U URLs below ##########$/d' ${@}
 )\
  | shuf\
  | eval ${CURL} -sK -
}

function filterPlaylist {
 sed -e "${@}"
}

function getStream {
 shuf | sed -e 's/^http/\nurl &/' | eval ${CURL} -sK -
}

# PLAY
(
 cat "${PLAYLIST_CACHE}" 2>/dev/null\
 || getPlaylist "${LIST}"\
     | filterPlaylist "${FILTERS} $@"\
     | tee "${PLAYLIST_CACHE}"
)\
 | case "${PLAYER_MODE}" in
    "stream"   ) getStream | mpv -             ;;
    "playlist" ) exec mpv --shuffle --playlist=- -- ;;
    *          ) exec cat                           ;;
   esac
exec ${0} ${@}
########## M3U URLs below ##########

#18 Summers /Synthpop/
url http://darkside.cc/m3u/group/4

# Doro /Hard Rock, Heavy Metal, Soft-Rock/
url http://darkside.cc/m3u/group/275

#Helloween /Power Metal, Speed Metal/
#url http://darkside.cc/m3u/group/540

#Nightwish /Opera Metal, Power Metal, Progressive/
url http://darkside.cc/m3u/group/786

#WarlocK /Heavy Metal/
url http://darkside.cc/m3u/group/1163

#Tarja /Neo-Classical/
url http://darkside.cc/m3u/group/2234

#Пелагея /Folk/
url http://darkside.cc/m3u/group/2341

#Кино /Rock/
url http://darkside.cc/m3u/group/265343

# Dolores O'Riordan /Rock/
url http://darkside.cc/m3u/group//277857
